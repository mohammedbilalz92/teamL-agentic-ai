<div class="chat-container">
  <div class="chat-header">
    <h1>Amstat RAG Chat Assistant</h1>
    <p>Ask questions about Amstat features and documentation</p>
  </div>

  <div class="chat-messages" #messagesContainer>
    <div *ngFor="let message of messages" class="message" [ngClass]="message.role">
      <div class="message-content">
        <div class="message-avatar">
          <span *ngIf="message.role === 'user'">ðŸ‘¤</span>
          <span *ngIf="message.role === 'assistant'">ðŸ¤–</span>
        </div>
        
        <div class="message-text">
          <div *ngIf="message.loading" class="loading-dots">
            <span></span>
            <span></span>
            <span></span>
          </div>
          <div *ngIf="!message.loading" [innerHTML]="formatMessage(message.content)"></div>
          
          <div *ngIf="message.sources && message.sources.length > 0 && showSources" class="sources">
            <details>
              <summary>Sources ({{ message.sources.length }})</summary>
              
              <!-- Show single video embed at the top if ANY sources are YouTube videos -->
              <div *ngIf="hasAnyYouTubeSource(message.sources)" class="shared-video-container">
                <div class="youtube-embed-container">
                  <iframe
                    *ngIf="getSingleYouTubeEmbedUrl(message.sources, messages.indexOf(message))"
                    [src]="getSingleYouTubeEmbedUrl(message.sources, messages.indexOf(message))"
                    [attr.data-source-key]="messages.indexOf(message) + '-shared'"
                    [attr.id]="'youtube-iframe-' + messages.indexOf(message) + '-shared'"
                    frameborder="0"
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                    allowfullscreen
                    class="youtube-embed"
                    loading="lazy">
                  </iframe>
                  <div *ngIf="!getSingleYouTubeEmbedUrl(message.sources, messages.indexOf(message))" class="youtube-error">
                    <p>Unable to load video. <a [href]="getSingleYouTubeUrl(message.sources)" target="_blank" rel="noopener noreferrer">Watch on YouTube â†—</a></p>
                  </div>
                  <div class="youtube-link">
                    <a [href]="getSingleYouTubeUrl(message.sources)" target="_blank" rel="noopener noreferrer">
                      Watch on YouTube â†—
                    </a>
                  </div>
                </div>
              </div>
              
              <ng-container *ngFor="let source of message.sources; let i = index">
                <div class="source-item">
                  <strong>{{ i + 1 }}. {{ source.topic }}</strong>
                  <div class="source-meta">
                    {{ source.title }} | Score: {{ source.score | number:'1.2-2' }} | 
                    <span class="timestamp-link" 
                          *ngIf="hasAnyYouTubeSource(message.sources) && source.timestamp_start"
                          (click)="playFromTimestamp(source.timestamp_start, messages.indexOf(message), i, source)"
                          [title]="'Play from ' + source.timestamp_start">
                      {{ source.timestamp_start }}
                    </span>
                    <span *ngIf="!hasAnyYouTubeSource(message.sources) || !source.timestamp_start">
                      {{ source.timestamp_start }}
                    </span>
                    - 
                    <span class="timestamp-link" 
                          *ngIf="hasAnyYouTubeSource(message.sources) && source.timestamp_end"
                          (click)="playFromTimestamp(source.timestamp_end, messages.indexOf(message), i, source)"
                          [title]="'Play from ' + source.timestamp_end">
                      {{ source.timestamp_end }}
                    </span>
                    <span *ngIf="!hasAnyYouTubeSource(message.sources) || !source.timestamp_end">
                      {{ source.timestamp_end }}
                    </span>
                  </div>
                </div>
              </ng-container>
            </details>
          </div>
          
          <div class="message-time">{{ formatTimestamp(message.timestamp) }}</div>
        </div>
      </div>
    </div>
  </div>

  <div class="chat-input-container">
    <div class="input-wrapper">
      <textarea
        [(ngModel)]="currentMessage"
        (keydown)="onKeyPress($event)"
        placeholder="Type your message here... (Press Enter to send, Shift+Enter for new line)"
        [disabled]="isLoading"
        rows="1"
        class="chat-input">
      </textarea>
      <button 
        (click)="sendMessage()" 
        [disabled]="isLoading || !currentMessage.trim()"
        class="send-button">
        <span *ngIf="!isLoading">Send</span>
        <span *ngIf="isLoading">Sending...</span>
      </button>
    </div>
    <div class="input-footer">
      <label>
        <input type="checkbox" [(ngModel)]="showSources"> Show sources
      </label>
    </div>
  </div>
</div>

